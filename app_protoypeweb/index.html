<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Industrial Doctor v1.0</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --green:  #00ff88;
    --yellow: #ffcc00;
    --red:    #ff2244;
    --cyan:   #00e5ff;
    --bg:     #080c10;
    --panel:  #0d1520;
    --border: #1a2940;
    --dim:    #1f3050;
  }

  * { box-sizing: border-box; }

  body {
    background-color: var(--bg);
    font-family: 'Share Tech Mono', monospace;
    color: #8ab4cc;
    overflow-x: hidden;
  }

  /* CRT scanline overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.15) 2px,
      rgba(0,0,0,0.15) 4px
    );
    pointer-events: none;
    z-index: 9999;
  }

  /* Noise texture */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9998;
    opacity: 0.4;
  }

  .orbitron { font-family: 'Orbitron', monospace; }
  .rajdhani { font-family: 'Rajdhani', sans-serif; }

  /* Panel styles */
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }
  .panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    opacity: 0.4;
  }

  /* Corner brackets */
  .bracket {
    position: relative;
  }
  .bracket::before,
  .bracket::after {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    border-color: var(--cyan);
    border-style: solid;
    opacity: 0.6;
  }
  .bracket::before { top: 4px; left: 4px; border-width: 2px 0 0 2px; }
  .bracket::after  { bottom: 4px; right: 4px; border-width: 0 2px 2px 0; }

  /* Pulsing live dot */
  @keyframes pulse-live {
    0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 0 0 rgba(0,255,136,0.7); }
    50% { opacity: 0.7; transform: scale(1.15); box-shadow: 0 0 0 6px rgba(0,255,136,0); }
  }
  .live-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse-live 1.4s ease-in-out infinite;
    display: inline-block;
  }

  /* Gauge */
  .gauge-ring {
    transform: rotate(-90deg);
  }
  .gauge-track { fill: none; stroke: #1a2940; }
  .gauge-fill  { fill: none; stroke-linecap: round; transition: stroke-dashoffset 0.7s cubic-bezier(.4,0,.2,1), stroke 0.5s; }

  /* Status bar */
  .status-bar {
    transition: background 0.6s ease, box-shadow 0.6s ease, color 0.6s ease;
  }
  .status-healthy   { background: rgba(0,255,136,0.12); box-shadow: 0 0 30px rgba(0,255,136,0.25), inset 0 0 40px rgba(0,255,136,0.06); color: var(--green); border-color: rgba(0,255,136,0.4) !important; }
  .status-maintenance { background: rgba(255,204,0,0.12); box-shadow: 0 0 30px rgba(255,204,0,0.25), inset 0 0 40px rgba(255,204,0,0.06); color: var(--yellow); border-color: rgba(255,204,0,0.4) !important; }
  .status-critical  { background: rgba(255,34,68,0.15); box-shadow: 0 0 30px rgba(255,34,68,0.3), inset 0 0 40px rgba(255,34,68,0.08); color: var(--red); border-color: rgba(255,34,68,0.5) !important; }

  /* Status bar flicker for critical */
  @keyframes flicker {
    0%,100% { opacity: 1; }
    92% { opacity: 1; }
    93% { opacity: 0.85; }
    94% { opacity: 1; }
    96% { opacity: 0.9; }
    97% { opacity: 1; }
  }
  .status-critical { animation: flicker 3s infinite; }

  /* Data cards */
  .data-card {
    background: linear-gradient(135deg, #0d1520 0%, #0a1018 100%);
    border: 1px solid var(--border);
    position: relative;
    transition: border-color 0.4s;
  }
  .data-card:hover { border-color: #2a4060; }

  .data-card-label {
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: #3a6080;
  }
  .data-card-value {
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    color: var(--cyan);
    text-shadow: 0 0 20px rgba(0,229,255,0.4);
    line-height: 1.1;
  }

  /* Scrolling log */
  .log-area {
    height: 160px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #1a3050 transparent;
  }
  .log-area::-webkit-scrollbar { width: 4px; }
  .log-area::-webkit-scrollbar-track { background: transparent; }
  .log-area::-webkit-scrollbar-thumb { background: #1a3050; border-radius: 2px; }

  .log-entry {
    padding: 4px 8px;
    border-left: 2px solid transparent;
    font-size: 0.7rem;
    line-height: 1.6;
    animation: fadeIn 0.4s ease;
  }
  .log-entry:hover { background: rgba(0,229,255,0.04); }
  .log-entry.healthy-log   { border-left-color: var(--green); }
  .log-entry.maintenance-log { border-left-color: var(--yellow); }
  .log-entry.critical-log  { border-left-color: var(--red); }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateX(-8px); }
    to   { opacity: 1; transform: translateX(0); }
  }

  /* Metric value update flash */
  @keyframes valueFlash {
    0%   { color: #ffffff; text-shadow: 0 0 30px rgba(255,255,255,0.8); }
    100% { color: var(--cyan); text-shadow: 0 0 20px rgba(0,229,255,0.4); }
  }
  .flash { animation: valueFlash 0.5s ease forwards; }

  /* Header glow line */
  .glow-line {
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, var(--cyan) 30%, var(--green) 70%, transparent 100%);
    opacity: 0.5;
  }

  /* Decorative hex pattern */
  .hex-bg {
    position: absolute;
    right: -20px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0.03;
    font-size: 120px;
    color: var(--cyan);
    font-family: 'Orbitron', monospace;
    user-select: none;
    pointer-events: none;
  }

  /* Grid lines */
  .grid-lines {
    background-image:
      linear-gradient(rgba(26,41,64,0.6) 1px, transparent 1px),
      linear-gradient(90deg, rgba(26,41,64,0.6) 1px, transparent 1px);
    background-size: 40px 40px;
  }

  /* Blinking cursor */
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
  .blink { animation: blink 1s step-end infinite; }

  /* Signal bars */
  .signal-bar { transition: height 0.3s ease, background 0.3s ease; }

  /* Frequency waveform */
  @keyframes wave1 { 0%,100%{d:path('M0 20 Q12 8 24 20 Q36 32 48 20 Q60 8 72 20')} 50%{d:path('M0 20 Q12 32 24 20 Q36 8 48 20 Q60 32 72 20')} }

  /* Spinning loader ring */
  @keyframes spin { to { stroke-dashoffset: 0; } }
</style>
</head>
<body class="min-h-screen p-4 grid-lines">

  <!-- ═══════════════════════════════════════════════════════ HEADER -->
  <header class="panel bracket mb-4 px-6 py-3 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div class="text-xs text-[#2a5070] rajdhani font-bold tracking-widest">SYS_ID: IND-DR-001</div>
      <div class="w-px h-5 bg-[#1a2940]"></div>
      <h1 class="orbitron text-xl font-900 tracking-widest" style="color:var(--cyan);text-shadow:0 0 25px rgba(0,229,255,0.5)">
        INDUSTRIAL<span style="color:var(--green)">DOCTOR</span>
      </h1>
      <span class="rajdhani text-xs text-[#2a5070] font-300 mt-1">v1.0</span>
    </div>

    <div class="flex items-center gap-6">
      <!-- Signal bars -->
      <div class="flex items-end gap-[3px] h-5">
        <div class="signal-bar w-2 rounded-sm" id="sig1" style="height:30%;background:var(--green)"></div>
        <div class="signal-bar w-2 rounded-sm" id="sig2" style="height:55%;background:var(--green)"></div>
        <div class="signal-bar w-2 rounded-sm" id="sig3" style="height:80%;background:var(--green)"></div>
        <div class="signal-bar w-2 rounded-sm" id="sig4" style="height:100%;background:var(--green)"></div>
      </div>

      <div class="flex items-center gap-2">
        <span class="live-dot"></span>
        <span class="orbitron text-xs font-700" style="color:var(--green);letter-spacing:.2em">LIVE</span>
      </div>

      <div class="text-right">
        <div class="orbitron text-xs" style="color:var(--cyan)" id="clock">--:--:--</div>
        <div class="text-[10px] text-[#2a5070]" id="datestamp">----/--/--</div>
      </div>
    </div>
  </header>

  <div class="glow-line mb-4"></div>

  <!-- ═══════════════════════════════════════════════════════ STATUS BAR -->
  <div id="statusBar" class="panel status-healthy border rounded mb-4 px-6 py-4 flex items-center justify-between" style="border:1px solid">
    <div class="flex items-center gap-4">
      <div class="text-[10px] tracking-[0.25em] text-[#3a6080]">SYSTEM HEALTH</div>
      <div class="w-px h-5 bg-[#1a2940]"></div>
      <div id="statusText" class="orbitron font-900 text-2xl tracking-widest">● HEALTHY</div>
    </div>
    <div class="flex items-center gap-6">
      <div class="text-right">
        <div class="text-[10px] text-[#3a6080] tracking-widest">UPTIME</div>
        <div class="orbitron text-sm" style="color:var(--cyan)" id="uptime">00:00:00</div>
      </div>
      <div class="text-right">
        <div class="text-[10px] text-[#3a6080] tracking-widest">READS</div>
        <div class="orbitron text-sm" style="color:var(--cyan)" id="readCount">0000</div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════ MAIN METRICS GRID -->
  <div class="grid grid-cols-2 gap-4 mb-4 lg:grid-cols-4">

    <!-- Machine Type -->
    <div class="data-card bracket p-5 relative" style="min-height:130px;">
      <div class="hex-bg">⬡</div>
      <div class="data-card-label mb-3">[ MACHINE TYPE ]</div>
      <div class="data-card-value text-lg leading-tight" id="machineType">—</div>
      <div class="absolute bottom-4 left-5 text-[10px] text-[#1a3050]">NODE_ID: M-001</div>
    </div>

    <!-- Peak Frequency -->
    <div class="data-card bracket p-5 relative" style="min-height:130px;">
      <div class="data-card-label mb-3">[ PEAK FREQUENCY ]</div>
      <div class="flex items-end gap-2">
        <div class="data-card-value" style="font-size:2.8rem;" id="peakFreq">—</div>
        <div class="text-sm text-[#2a5070] mb-2">Hz</div>
      </div>
      <!-- Mini frequency wave -->
      <svg width="80" height="24" class="absolute bottom-4 right-4 opacity-30">
        <polyline id="waveform" points="0,12 10,4 20,12 30,20 40,12 50,4 60,12 70,20 80,12"
          fill="none" stroke="#00e5ff" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
    </div>

    <!-- Intensity Gauge -->
    <div class="data-card p-5 relative flex flex-col items-center justify-center" style="min-height:130px;">
      <div class="data-card-label mb-2">[ INTENSITY SCORE ]</div>
      <div class="relative flex items-center justify-center" style="width:90px;height:90px;">
        <svg width="90" height="90" class="gauge-ring absolute">
          <circle class="gauge-track" cx="45" cy="45" r="36" stroke-width="7"/>
          <circle class="gauge-fill" id="gaugeFill" cx="45" cy="45" r="36" stroke-width="7"
            stroke="var(--cyan)"
            stroke-dasharray="226.2"
            stroke-dashoffset="226.2"/>
        </svg>
        <div class="text-center z-10">
          <div class="orbitron font-700" style="font-size:1.35rem;color:var(--cyan);text-shadow:0 0 15px rgba(0,229,255,0.5)" id="intensityVal">—</div>
          <div class="text-[9px] text-[#2a5070] tracking-widest">/ 100</div>
        </div>
      </div>
    </div>

    <!-- Diagnosis -->
    <div class="data-card bracket p-5 relative" style="min-height:130px;">
      <div class="hex-bg" style="font-size:80px;opacity:0.04">Rx</div>
      <div class="data-card-label mb-3">[ AI DIAGNOSIS ]</div>
      <div class="orbitron font-700 text-sm leading-snug" style="color:var(--green);text-shadow:0 0 15px rgba(0,255,136,0.35)" id="diagnosis">—</div>
      <div class="absolute bottom-4 left-5 right-5">
        <div class="w-full h-px" style="background:linear-gradient(90deg,transparent,var(--green),transparent);opacity:0.2"></div>
      </div>
    </div>

  </div>

  <!-- ═══════════════════════════════════════════════════════ LIVE FEED -->
  <div class="panel bracket p-4">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-3">
        <div class="text-[10px] tracking-[0.2em] text-[#3a6080]">LIVE DATA FEED</div>
        <span class="blink text-[var(--cyan)]" style="font-size:0.65rem">█</span>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-[10px] text-[#2a5070]">FORMAT: CSV — MachineType, PeakFreq, Intensity, Health, Diagnosis</div>
        <button onclick="clearLog()" class="text-[9px] tracking-widest text-[#2a5070] hover:text-[#8ab4cc] transition-colors border border-[#1a2940] hover:border-[#2a4060] px-2 py-1 rajdhani">CLR</button>
      </div>
    </div>
    <div class="log-area" id="logArea">
      <div class="log-entry text-[#2a5070]">// Awaiting data stream...</div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════ FOOTER -->
  <footer class="mt-4 flex justify-between items-center text-[10px] text-[#1f3050]">
    <div>INDUSTRIAL DOCTOR v1.0 — MACHINE HEALTH MONITORING SYSTEM</div>
    <div class="flex gap-6">
      <span>PROTOCOL: CSV/RAW</span>
      <span>REFRESH: 2000ms</span>
      <span id="lastUpdate">LAST UPDATE: —</span>
    </div>
  </footer>

<script>
// ───────────────────────────────────────────────────────────
// STATE
let readCount = 0;
let startTime = Date.now();

// ───────────────────────────────────────────────────────────
// CLOCK
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    now.toTimeString().slice(0,8);
  document.getElementById('datestamp').textContent =
    now.toISOString().slice(0,10).replace(/-/g,'/');

  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  const h = String(Math.floor(elapsed/3600)).padStart(2,'0');
  const m = String(Math.floor((elapsed%3600)/60)).padStart(2,'0');
  const s = String(elapsed%60).padStart(2,'0');
  document.getElementById('uptime').textContent = `${h}:${m}:${s}`;
}
setInterval(updateClock, 1000);
updateClock();

// ───────────────────────────────────────────────────────────
// MAIN PARSE + RENDER
function processCSV(csvString) {
  const parts = csvString.split(',').map(s => s.trim());
  if (parts.length < 5) return;

  const [machineType, peakFreq, intensity, healthStatus, diagnosis] = parts;
  const intensityNum = Math.min(100, Math.max(0, parseFloat(intensity) || 0));

  // Update cards with flash effect
  setFlash('machineType', machineType);
  setFlash('peakFreq', peakFreq);
  setFlash('diagnosis', diagnosis.toUpperCase());

  // Intensity gauge
  const circumference = 226.2;
  const offset = circumference - (intensityNum / 100) * circumference;
  const fill = document.getElementById('gaugeFill');
  fill.style.strokeDashoffset = offset;

  // Gauge color based on intensity
  if (intensityNum >= 80) fill.style.stroke = 'var(--red)';
  else if (intensityNum >= 50) fill.style.stroke = 'var(--yellow)';
  else fill.style.stroke = 'var(--cyan)';

  setFlash('intensityVal', Math.round(intensityNum));

  // Status bar
  updateStatus(healthStatus.trim());

  // Animate waveform
  animateWaveform(parseFloat(peakFreq) || 0);

  // Log entry
  addLogEntry(csvString, healthStatus.trim());

  // Update counters
  readCount++;
  document.getElementById('readCount').textContent = String(readCount).padStart(4,'0');
  document.getElementById('lastUpdate').textContent =
    'LAST UPDATE: ' + new Date().toTimeString().slice(0,8);
}

function setFlash(id, value) {
  const el = document.getElementById(id);
  el.textContent = value;
  el.classList.remove('flash');
  void el.offsetWidth;
  el.classList.add('flash');
}

// ───────────────────────────────────────────────────────────
// STATUS BAR
function updateStatus(healthStatus) {
  const bar = document.getElementById('statusBar');
  const txt = document.getElementById('statusText');
  bar.className = 'panel border rounded mb-4 px-6 py-4 flex items-center justify-between status-bar';

  const status = healthStatus.toLowerCase();
  if (status === 'healthy') {
    bar.classList.add('status-healthy');
    txt.textContent = '● HEALTHY';
  } else if (status.includes('maintenance')) {
    bar.classList.add('status-maintenance');
    txt.textContent = '▲ MAINTENANCE NEEDED';
  } else if (status === 'critical') {
    bar.classList.add('status-critical');
    txt.textContent = '✖ CRITICAL';
  } else {
    bar.classList.add('status-healthy');
    txt.textContent = '● ' + healthStatus.toUpperCase();
  }
}

// ───────────────────────────────────────────────────────────
// WAVEFORM
function animateWaveform(freq) {
  const wave = document.getElementById('waveform');
  const amplitude = Math.min(10, freq / 20);
  const pts = [];
  for (let i = 0; i <= 8; i++) {
    const x = i * 10;
    const y = 12 + (i % 2 === 0 ? -amplitude : amplitude);
    pts.push(`${x},${y.toFixed(1)}`);
  }
  wave.setAttribute('points', pts.join(' '));
}

// ───────────────────────────────────────────────────────────
// LOG
function addLogEntry(csv, health) {
  const log = document.getElementById('logArea');
  const time = new Date().toTimeString().slice(0,8);
  const entry = document.createElement('div');

  const status = health.toLowerCase();
  let cls = 'healthy-log';
  if (status.includes('maintenance')) cls = 'maintenance-log';
  else if (status === 'critical') cls = 'critical-log';

  entry.className = `log-entry ${cls}`;
  entry.innerHTML =
    `<span style="color:#2a5070">[${time}]</span> ` +
    `<span style="color:#8ab4cc">${csv}</span>`;

  log.insertBefore(entry, log.firstChild);

  // Keep max 50 entries
  while (log.children.length > 50) {
    log.removeChild(log.lastChild);
  }
}

function clearLog() {
  const log = document.getElementById('logArea');
  log.innerHTML = '<div class="log-entry text-[#2a5070]">// Log cleared.</div>';
}

// ───────────────────────────────────────────────────────────
// PUBLIC API: call this with your CSV string
window.ingestCSV = function(csvString) {
  processCSV(csvString);
};
/*
// ───────────────────────────────────────────────────────────
// DEMO SIMULATOR
const demoData = [
  'Centrifugal Water Pump, 58.4, 22, Healthy, Normal Operation',
  'Rotary Compressor, 72.1, 55, Maintenance Needed, Bearing Wear Detected',
  'Conveyor Belt Drive, 45.8, 18, Healthy, Stable Load',
  'Industrial Turbine, 110.3, 91, Critical, Vibration Spike – Imbalance',
  'Hydraulic Press, 33.6, 37, Healthy, Idle Cycle',
  'Cooling Tower Fan, 60.0, 48, Maintenance Needed, Fan Blade Erosion',
  'Gear Reducer, 88.7, 79, Critical, Gear Mesh Frequency Anomaly',
  'Centrifugal Pump A2, 55.2, 20, Healthy, Normal Operation',
  'Air Compressor, 66.5, 62, Maintenance Needed, Pressure Fluctuation',
  'Electric Motor 3-Phase, 50.0, 30, Healthy, Balanced Load',
];



let demoIndex = 0;
function runDemo() {
  processCSV(demoData[demoIndex % demoData.length]);
  demoIndex++;
}

// Kick off immediately then every 2 seconds
runDemo();
setInterval(runDemo, 2000);

*/
// Replace the runDemo logic with this:
const socket = new WebSocket(`ws://${window.location.host}`);

socket.onmessage = function(event) {
    // This calls the existing ingestCSV function with real ESP32 data!
    window.ingestCSV(event.data);
};

// Remove or comment out these lines:
// runDemo();
// setInterval(runDemo, 2000);
</script>
</body>
</html>
